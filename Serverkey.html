<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <title>Key Hôm Nay</title>
  <style>
    :root{
        --bg: #0f1724;
        --card: #0b1220;
        --accent: #06b6d4;
        --muted: #94a3b8;
        --white: #e6eef6;
        --success: #10b981;
        --error: #ef4444;
    }
    *{
        box-sizing:border-box
    }
    body{
        margin:0;
        min-height:100vh;
        background:linear-gradient(180deg,#071028 0%,#0b1220 100%);
        font-family:Inter,system-ui,Arial;color:
    var(--white);
        display:flex;
        align-items:center;
        justify-content:center;
        padding:24px
    }
    .card{
        width:100%;
        max-width:400px;
        background:var(--card);
        border-radius:12px;
        padding:24px;
        box-shadow: 0 0px 15px cyan, 0px 0px 15px cyan inset;
        border: solid cyan;
        position: relative; /* Thêm position relative để định vị thông báo */
    }
    h1{
        margin:0 0 18px;
        font-size:20px;
        text-align:center; 
        border: none;
        color: cyan;
    }
    form{
        display:grid;
        gap:12px;
    }
    .key-box{
        width: 300px;
        height:60px;
        margin-left: 7%;
        display:flex;
        align-items: center;
        justify-content:center;
        border-radius:8px;
        border: none;
        font-family:monospace;
        font-size:28px;
        box-shadow: 0 0px 15px var(--card), 0px 0px 15px var(--card) inset;
    }
    .key-box:hover{
        color: rgb(0, 225, 255);
        width: 300px;
        height:60px;
        margin-left: 7%;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:8px;
        border: solid cyan;
        font-family:monospace;
        font-size:28px;
        box-shadow: 0 0px 15px cyan, 0px 0px 15px cyan inset;
        transform: translateY(-2px) scale(1.05);
        transition: 1s;
    }
    .controls{
        display:flex;
        gap:10px;
        justify-content:center}
    button{
        color: black;
        background-color: black;
        font-weight: 600;
        padding: 0.8rem 1.5em;
        box-shadow: 0 0px 15px black, 0px 0px 15px black inset;
        border: solid black;
        border-radius: 0.66em;
        cursor: pointer;
        transition: 0.3s;
    }
    button:hover{
        color: rgb(0, 225, 255);
        border: solid cyan;
        box-shadow: 0 0px 15px cyan, 0px 0px 15px cyan inset;
        transform: translateY(-2px) scale(1.05);
        transition: 1s;
    }
    .btn-primary{
        color:rgb(21, 27, 27);
        box-shadow:0 6px 18px rgba(6,182,212,.12);
        margin-bottom: -10px;
        height: 50px;
    }

    @media (max-width:420px){
        .card{padding:16px}
        .key-box{height:80px;
        font-size:22px
        }}

    /* Thêm style cho thông báo */
    #status-message {
        text-align: center;
        margin-top: 15px;
        padding: 8px;
        border-radius: 6px;
        font-weight: 600;
        min-height: 20px;
    }
    .status-success {
        background-color: var(--success);
        color: var(--card);
    }
    .status-error {
        background-color: var(--error);
        color: var(--white);
    }

    .song{
      position: fixed;
      bottom: 20px;
      left: 10px;
      width: 100%;
      text-align: center;
      background: rgba(0,0,0,0,6);
      color: var(--white);
      padding: 10px0;
    }
    .player{
      background: url(song.png);
      color: var(--white);
      width: 300px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-radius: 10px;
      background-size: 500px auto;
      background-repeat: no-repeat;
      background-position: center;
      
    }

    .cover{
      background: white;
      height: 50px;
      width: 50px;
      border-radius: 5px;
    }

    .info{
      display: flex;
      width: 50%;
      gap: 10px;
    }

    .playing{
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
    }

    .title{
      font-weight: bold;
      font-size: 14px;
    }

    .artist{
      font-size: 12px;
    }

    .diuekhien{
      margin-right: 20px;
      cursor: pointer;
      display: flex;
      gap: 5px;
      color: var(--white);
    }
    #music-btn{
      background: none;
      border: none;
      font-size: 10px;
      color: var(--white);
      cursor: pointer;
      transition: transform 0.2s;
    }
  </style>
</head>
<body>
  <div class="card" role="application">
    <h1 id="pageTitle">Key Hôm Nay</h1>

    <form id="keyForm" onsubmit="return false;">
      <div class="key-box" id="keyBox" aria-live="polite">--</div>
      <div class="controls">
        <button id="genBtn" type="button" class="btn-primary">Nhận Key</button>
      </div>
      <div id="status-message"></div>
    </form>
  </div>

  <div class="song">
    <div class="player">
      <div class="info">
        <div class="cover">
          <img src="logoshop.png" width="50px">
        </div>
        <div class="playing">
          <div class="title">23:40</div>
          <div class="artist">Artist</div>
        </div>
      </div>
      <div class="diuekhien">
        <audio id="music" src="23_40.mp3"></audio>
        <button id="music-btn" onclick="toggleMusic()"><i id="music-icon" class="fa-solid fa-play"></i></button>
      </div>
    </div>
  </div>

<script>
const GITHUB_TOKEN = "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";
const REPO = "kkkkk5234/toolgopv1"; 
const FILE_PATH = "key.json";

let isPlaying = false;
function toggleMusic() {
  const music = document.getElementById("music");
  const icon = document.getElementById("music-icon");
  if (!isPlaying) {
    music.play();
    icon.classList.replace('fa-play','fa-pause');
  } else {
    music.pause();
    icon.classList.replace('fa-pause','fa-play');
  }
  isPlaying = !isPlaying;
}

(async function(){
  const titleEl = document.getElementById('pageTitle');
  const keyBox = document.getElementById('keyBox');
  const genBtn = document.getElementById('genBtn');
  const statusEl = document.getElementById('status-message');
  
  const STORAGE_TAKEN = 'tk_key_taken';
  const STORAGE_KEY = 'tk_generated_key';
  const STORAGE_DATE = 'tk_key_date';

  function todayStr(){
    const t = new Date();
    return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  }

  function renderDate(){
    const t = new Date();
    titleEl.textContent = `Key Hôm Nay - ${String(t.getDate()).padStart(2,'0')}/${String(t.getMonth()+1).padStart(2,'0')}/${t.getFullYear()}`;
    document.querySelector('.title').textContent = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`;
  }

  function generateKey(){

    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let key = '';
    for(let i=0;i<6;i++) key += chars[Math.floor(Math.random()*chars.length)];
    return key;
  }

  function disableGen(){ genBtn.disabled = true; genBtn.style.opacity = 0.6; genBtn.textContent = 'Đã Nhận Key';}
  function enableGen(){ genBtn.disabled = false; genBtn.style.opacity = 1; genBtn.textContent = 'Nhận Key';}

  function showStatus(message, isError = false) {
    statusEl.textContent = message;
    statusEl.className = isError ? 'status-error' : 'status-success';
  }

  function initFromStorage(){
    const savedDate = localStorage.getItem(STORAGE_DATE);
    const savedKey = localStorage.getItem(STORAGE_KEY);
    const taken = localStorage.getItem(STORAGE_TAKEN);
    const today = todayStr();
    
    if(savedDate === today && taken === 'taken' && savedKey){
      keyBox.textContent = savedKey; 
      disableGen(); 
      showStatus('Bạn đã nhận key hôm nay.');
      return;
    }
    
    keyBox.textContent = '--'; 
    enableGen();
    showStatus('');
  }

  async function fetchFileInfo() {
    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`, {
        headers: {
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json"
        }
    });
    if (!res.ok) {
        const error = await res.json();
        throw new Error(`Lỗi khi lấy thông tin file (${res.status}): ${error.message || res.statusText}`);
    }
    return await res.json();
  }

  async function updateFile(newContent, sha) {
    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`, {
      method: "PUT",
      headers: {
        "Authorization": `token ${GITHUB_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `[AUTO] Cập nhật key free ngày ${todayStr()}`,
        
        content: btoa(unescape(encodeURIComponent(newContent))),
        sha: sha 
      })
    });

    if (!res.ok) {
        const error = await res.json();
        throw new Error(`Lỗi khi cập nhật file (${res.status}): ${error.message || res.statusText}`);
    }
    return await res.json();
  }

  genBtn.addEventListener('click', async ()=>{
    const today = todayStr();
    if(localStorage.getItem(STORAGE_DATE) === today && localStorage.getItem(STORAGE_TAKEN) === 'taken') return;

    const key = generateKey();
    keyBox.textContent = key;
    localStorage.setItem(STORAGE_KEY, key);
    localStorage.setItem(STORAGE_DATE, today);
    localStorage.setItem(STORAGE_TAKEN, 'taken');
    disableGen();
    showStatus('Đang cập nhật key', false);

    try {

      const file = await fetchFileInfo();
      const sha = file.sha;
      
      const fileContentBase64 = file.content.replace(/\s/g, ''); 
      const oldContentJson = atob(fileContentBase64); 
      const oldContent = JSON.parse(oldContentJson);
      
      if (Array.isArray(oldContent)) {
          oldContent.push(key);
      } else {

          console.warn("File key.json không phải là mảng. Ghi đè bằng mảng mới.");
          const date_time = new Date().toISOString();
          oldContent = [{key: key, date: date_time, note: "Khởi tạo mảng mới"}];
      }

      const newContent = JSON.stringify(oldContent, null, 2);
      
      await updateFile(newContent, sha);
      
      showStatus("Đã cập nhật key thành công!", false);
      
      console.log("Cập nhật key thành công.");
    } catch (e) {

      showStatus("...", true);
      console.error("Không thể cập nhật key:", e);
    }
  });

  renderDate();
  initFromStorage();
})();
</script>
</body>
</html>
