<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>KEY NGÀY</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body {
      background: black;
      color: white;
      font-family: monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      border: 2px solid white;
      padding: 24px;
      text-align: center;
      width: 320px;
      border-radius: 12px;
    }
    button {
      background: white;
      color: black;
      border: none;
      padding: 10px 20px;
      margin-top: 12px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 8px;
    }
    #keyBox {
      border: 1px solid white;
      padding: 10px;
      margin-top: 15px;
      font-size: 18px;
      letter-spacing: 2px;
      background: #111;
    }
    input {
      padding: 8px;
      width: 80%;
      border-radius: 6px;
      border: 1px solid white;
      background: #111;
      color: white;
      margin-top: 10px;
      text-align: center;
    }
    .muted { color: #ccc; font-size: 12px; margin-top:8px; }
  </style>
</head>
<body>

  <div class="card" id="passwordCard">
    <h2>Nhập mật khẩu để nhận key</h2>
    <input type="password" id="passwordInput" placeholder="Mật khẩu">
    <br>
    <button id="submitPassword">Xác nhận</button>
    <div id="passwordMsg" style="color:#ff7b7b;margin-top:8px;"></div>
    <div class="muted" id="fetchStatus">Đang tải key từ server</div>
  </div>

  <div class="card" id="keyCard" style="display:none;">
    <h2 id="title"></h2>
    <div id="keyBox">---</div>
    <button type="button" id="getKeyBtn">Nhận key</button>
    <div class="muted" style="margin-top:8px">Key chỉ có tác dụng trong 24h</div>
  </div>

<script>
const MK_JSON_URL = 'https://raw.githubusercontent.com/kkkkk5234/toolgopv1/main/key.json'; 
const FORMSPREE_URL = 'https://formspree.io/f/xpwjelky'; 
  
const passwordCard = document.getElementById('passwordCard');
const passwordInput = document.getElementById('passwordInput');
const submitPassword = document.getElementById('submitPassword');
const passwordMsg = document.getElementById('passwordMsg');
const fetchStatus = document.getElementById('fetchStatus');

const keyCard = document.getElementById('keyCard');
const titleEl = document.getElementById('title');
const keyBox = document.getElementById('keyBox');
const getKeyBtn = document.getElementById('getKeyBtn');

const today = new Date();
const dateStr = today.toLocaleDateString("vi-VN");
titleEl.innerText = "KEY NGÀY - " + dateStr;

const lastKeyDate = localStorage.getItem("lastKeyDate");
if (lastKeyDate === dateStr) {
  getKeyBtn.disabled = true;
  keyBox.textContent = localStorage.getItem("key");
}

let currentMk = null;
let mkLoaded = false;

async function loadMkJson(){
  fetchStatus.textContent = 'Đang kiểm tra key';
  try {
    const res = await fetch(MK_JSON_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();

    currentMk = j.mk || j.Mk || j.MK || j['Mk:'] || j['mk:'] || null;

    if (typeof currentMk === 'string') {
      currentMk = currentMk.trim();
    }
    if (!currentMk) {
      fetchStatus.textContent = 'Mật khẩu sai';
      mkLoaded = false;
    } else {
      fetchStatus.textContent = 'Mật khẩu đúng';
      mkLoaded = true;
    }
  } catch (err) {
    console.error('Lỗi khi fetch :', err);
    fetchStatus.textContent = 'Lỗi kết nối server: ' + (err.message || err);
    mkLoaded = false;
  }
}

loadMkJson();

function randomKey() {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const digits = "0123456789";
  let l = "", d = "";
  for (let i = 0; i < 3; i++) {
      l += letters[Math.floor(Math.random() * letters.length)];
      d += digits[Math.floor(Math.random() * digits.length)];
  }
  return l + d;
}

async function sendKeyToFormspree(key, date) {
  const data = { 'Key_Value': key, 'Date_Generated': date };
  try {
    const response = await fetch(FORMSPREE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify(data)
    });
    if (response.ok) {
      console.log('Key đã được gửi về tool!');
    } else {
      console.error('Lỗi khi gửi key về tool:', response.statusText);
    }
  } catch (error) {
    console.error('Lỗi kết nối tool:', error);
  }
}

submitPassword.onclick = async () => {
  const input = (passwordInput.value || '').trim();
  passwordMsg.textContent = '';

  if (!mkLoaded) {
    fetchStatus.textContent = 'Gặp lỗi server đang được nhân viên kiểm tra lại...';
    await loadMkJson();
  }

  if (!mkLoaded) {
    passwordMsg.textContent = 'Không thể kết nối server';
    return;
  }

  if (input === currentMk) {
    passwordInput.value = '';
    passwordCard.style.display = 'none';
    keyCard.style.display = 'block';
    sessionStorage.setItem('auth_ok', '1');
  } else {
    passwordMsg.textContent = 'Mật khẩu sai — không thể vào.';
    await loadMkJson();
  }
};

if (sessionStorage.getItem('auth_ok') === '1') {
  passwordCard.style.display = 'none';
  keyCard.style.display = 'block';
}

getKeyBtn.onclick = async () => {
  const key = randomKey();
  keyBox.textContent = key;
  getKeyBtn.disabled = true;
  localStorage.setItem("lastKeyDate", dateStr);
  localStorage.setItem("key", key);
  await sendKeyToFormspree(key, dateStr);
};
</script>

</body>
</html>>
</html>
